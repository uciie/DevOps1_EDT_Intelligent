<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TravelTimeService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">backend</a> &gt; <a href="index.source.html" class="el_package">com.example.backend.service</a> &gt; <span class="el_source">TravelTimeService.java</span></div><h1>TravelTimeService.java</h1><pre class="source lang-java linenums">package com.example.backend.service;

import com.example.backend.model.Event;
import com.example.backend.model.Location;
import com.example.backend.model.TravelTime;
import com.example.backend.model.TravelTime.TransportMode;
import com.example.backend.repository.EventRepository;
import com.example.backend.repository.TravelTimeRepository;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.List;

/**
 * Service pour calculer et gérer les temps de trajet entre événements
 */
@Service
public class TravelTimeService {

    private final TravelTimeRepository travelTimeRepository;
    private final TravelTimeCalculator travelTimeCalculator;
    private final EventRepository eventRepository;

    public TravelTimeService(TravelTimeRepository travelTimeRepository,
                            TravelTimeCalculator travelTimeCalculator,
<span class="fc" id="L27">                            EventRepository eventRepository) {</span>
<span class="fc" id="L28">        this.travelTimeRepository = travelTimeRepository;</span>
<span class="fc" id="L29">        this.travelTimeCalculator = travelTimeCalculator;</span>
<span class="fc" id="L30">        this.eventRepository = eventRepository;</span>
<span class="fc" id="L31">    }</span>

    /**
     * Récupère tous les temps de trajet d'un utilisateur.
     *
     * @param userId l'ID de l'utilisateur
     * @return liste des temps de trajet
     */
    public List&lt;TravelTime&gt; getTravelTimesByUserId(Long userId) {
<span class="fc" id="L40">        return travelTimeRepository.findByUser_Id(userId);</span>
    }

    /**
     * Récupère les temps de trajet d'un utilisateur dans une période donnée.
     *
     * @param userId l'ID de l'utilisateur
     * @param start date de début
     * @param end date de fin
     * @return liste des temps de trajet
     */
    public List&lt;TravelTime&gt; getTravelTimesByUserIdAndDateRange(Long userId, LocalDateTime start, LocalDateTime end) {
<span class="fc" id="L52">        return travelTimeRepository.findByUser_IdAndStartTimeBetween(userId, start, end);</span>
    }

    /**
     * Calcule et crée un temps de trajet entre deux événements à partir de leurs IDs.
     *
     * @param fromEventId l'ID de l'événement de départ
     * @param toEventId l'ID de l'événement d'arrivée
     * @param mode le mode de transport
     * @return le temps de trajet créé
     */
    @Transactional
    public TravelTime calculateAndCreateTravelTime(Long fromEventId, Long toEventId, TransportMode mode) {
<span class="fc" id="L65">        Event fromEvent = eventRepository.findById(fromEventId)</span>
<span class="fc" id="L66">                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;FromEvent not found&quot;));</span>
<span class="fc" id="L67">        Event toEvent = eventRepository.findById(toEventId)</span>
<span class="fc" id="L68">                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;ToEvent not found&quot;));</span>
        
<span class="fc" id="L70">        return createTravelTime(fromEvent, toEvent, mode);</span>
    }

    /**
     * Calcule et crée un temps de trajet entre deux événements.
     *
     * @param fromEvent l'événement de départ
     * @param toEvent l'événement d'arrivée
     * @param mode le mode de transport
     * @pre fromEvent et toEvent doivent avoir une localisation définie
     * @return le temps de trajet créé
     */
    @Transactional
    public TravelTime createTravelTime(Event fromEvent, Event toEvent, TransportMode mode) {
        // Vérifie que les deux événements ont une localisation
<span class="fc bfc" id="L85" title="All 4 branches covered.">        if (fromEvent.getLocation() == null || toEvent.getLocation() == null) {</span>
<span class="fc" id="L86">            throw new IllegalArgumentException(&quot;Les événements doivent avoir une localisation&quot;);</span>
        }

        // Calcule le temps de trajet
<span class="fc" id="L90">        int durationMinutes = travelTimeCalculator.calculateTravelTime(</span>
<span class="fc" id="L91">            fromEvent.getLocation(), </span>
<span class="fc" id="L92">            toEvent.getLocation(), </span>
            mode
        );

        // Le trajet commence à la fin de l'événement précédent
<span class="fc" id="L97">        LocalDateTime travelStartTime = fromEvent.getEndTime();</span>

        // Crée l'objet TravelTime
<span class="fc" id="L100">        TravelTime travelTime = new TravelTime(</span>
            fromEvent, 
            toEvent, 
<span class="fc" id="L103">            fromEvent.getUser(),</span>
            travelStartTime, 
            durationMinutes
        );
<span class="fc" id="L107">        travelTime.setMode(mode);</span>

        // Calcule aussi la distance si possible
<span class="pc bpc" id="L110" title="1 of 2 branches missed.">        if (fromEvent.getLocation().hasCoordinates() &amp;&amp; </span>
<span class="pc bpc" id="L111" title="1 of 2 branches missed.">            toEvent.getLocation().hasCoordinates()) {</span>
<span class="fc" id="L112">            double distance = calculateDistance(</span>
<span class="fc" id="L113">                fromEvent.getLocation(), </span>
<span class="fc" id="L114">                toEvent.getLocation()</span>
            );
<span class="fc" id="L116">            travelTime.setDistanceKm(distance);</span>
        }

<span class="fc" id="L119">        return travelTimeRepository.save(travelTime);</span>
    }

    /**
     * Met à jour le temps de trajet en fonction des modifications d'événements.
     *
     * @param travelTimeId l'ID du temps de trajet
     * @param newStartTime la nouvelle heure de début
     */
    @Transactional
    public void updateTravelTime(Long travelTimeId, LocalDateTime newStartTime) {
<span class="fc" id="L130">        TravelTime travelTime = travelTimeRepository.findById(travelTimeId)</span>
<span class="fc" id="L131">            .orElseThrow(() -&gt; new IllegalArgumentException(&quot;TravelTime not found&quot;));</span>
        
<span class="fc" id="L133">        travelTime.setStartTime(newStartTime);</span>
<span class="fc" id="L134">        travelTimeRepository.save(travelTime);</span>
<span class="fc" id="L135">    }</span>

    /**
     * Supprime un temps de trajet.
     *
     * @param travelTimeId l'ID du temps de trajet
     */
    @Transactional
    public void deleteTravelTime(Long travelTimeId) {
<span class="fc" id="L144">        travelTimeRepository.deleteById(travelTimeId);</span>
<span class="fc" id="L145">    }</span>

    /**
     * Calcule la distance entre deux lieux en kilomètres (formule de Haversine).
     *
     * @param from la localisation de départ
     * @param to la localisation d'arrivée
     * @return la distance en kilomètres
     */
    private double calculateDistance(Location from, Location to) {
<span class="fc" id="L155">        final int EARTH_RADIUS = 6371; // Rayon de la Terre en km</span>

<span class="fc" id="L157">        double latDistance = Math.toRadians(to.getLatitude() - from.getLatitude());</span>
<span class="fc" id="L158">        double lonDistance = Math.toRadians(to.getLongitude() - from.getLongitude());</span>

<span class="fc" id="L160">        double a = Math.sin(latDistance / 2) * Math.sin(latDistance / 2)</span>
<span class="fc" id="L161">                + Math.cos(Math.toRadians(from.getLatitude())) </span>
<span class="fc" id="L162">                * Math.cos(Math.toRadians(to.getLatitude()))</span>
<span class="fc" id="L163">                * Math.sin(lonDistance / 2) * Math.sin(lonDistance / 2);</span>

<span class="fc" id="L165">        double c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));</span>

<span class="fc" id="L167">        return EARTH_RADIUS * c;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>